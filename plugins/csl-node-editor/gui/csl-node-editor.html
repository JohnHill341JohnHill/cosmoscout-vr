<!-- 
SPDX-FileCopyrightText: German Aerospace Center (DLR) <cosmoscout@dlr.de>
SPDX-License-Identifier: MIT
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Node Editor</title>

  <script src="https://cdn.jsdelivr.net/npm/rete@1.5.0-rc1/build/rete.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alight@0.14.1/alight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-vue-render-plugin@0.5.1/build/vue-render-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-connection-plugin@0.9.0/build/connection-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-comment-plugin@0.3.0/build/comment-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-context-menu-plugin@0.5.2/build/context-menu-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-history-plugin@0.1.0/build/history-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-area-plugin@0.2.1/build/area-plugin.min.js"></script>

  <script type="text/javascript" src="third-party/js/jquery-2.2.3.min.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap-datepicker.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap-select.min.js"></script>

  <script type="text/javascript" src="third-party/js/d3.min.js"></script>
  <script type="text/javascript" src="third-party/js/fuzzyset.js"></script>
  <script type="text/javascript" src="third-party/js/nouislider.min.js"></script>

  <link type="text/css" rel="stylesheet" href="third-party/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="third-party/css/bootstrap-select.min.css" />
  <link type="text/css" rel="stylesheet" href="third-party/css/nouislider.css">

  <link type="text/css" rel="stylesheet" href="css/calendar.css">
  <link type="text/css" rel="stylesheet" href="css/gui.css">
  <link type="text/css" rel="stylesheet" href="css/csl-node-editor.css">
</head>

<body>

  <div id="rete"></div>

  <script type="text/javascript">
    function toKebabCase(string) {
      return string
        .replace(/([a-z])([A-Z])/g, "$1-$2")
        .replace(/[\s_]+/g, '-')
        .toLowerCase();
    }

    function addSocketStyle(name, color) {
      const css = document.createElement("style");
      css.innerText = `
        .socket.${toKebabCase(name)} {
          background: ${color};
        }
      `;
      document.head.appendChild(css);
    }

    let SOCKETS = [];

    //!SOCKET_SOURCE_CODE

    //!NODE_SOURCE_CODE


    // class AddComponent extends Rete.Component {
    //   constructor() {
    //     super("Add");
    //   }

    //   builder(node) {
    //     var inp1 = new Rete.Input('num', "Number", numSocket);
    //     var inp2 = new Rete.Input('num2', "Number2", numSocket);
    //     var out = new Rete.Output('num', "Number", numSocket);

    //     inp1.addControl(new NumControl(this.editor, 'num'))
    //     inp2.addControl(new NumControl(this.editor, 'num2'))

    //     return node
    //       .addInput(inp1)
    //       .addInput(inp2)
    //       .addControl(new NumControl(this.editor, 'preview', true))
    //       .addOutput(out);
    //   }

    //   worker(node, inputs, outputs) {
    //     var n1 = inputs['num'].length ? inputs['num'][0] : node.data.num1;
    //     var n2 = inputs['num2'].length ? inputs['num2'][0] : node.data.num2;
    //     var sum = n1 + n2;

    //     this.editor.nodes.find(n => n.id == node.id).controls.get('preview').setValue(sum);
    //     outputs['num'] = sum;
    //   }
    // }

    (async () => {
      const container = document.querySelector('#rete');

      const background = document.createElement('div');
      background.classList = 'background';

      const editor = new Rete.NodeEditor('node-editor@0.1.0', container);
      editor.use(ConnectionPlugin.default);
      editor.use(VueRenderPlugin.default);
      editor.use(CommentPlugin.default);
      editor.use(ContextMenuPlugin.default, {
        allocate(component) {
          return component.category ? [component.category] : [];
        },
      });
      editor.use(AreaPlugin, { background });
      editor.use(HistoryPlugin);

      const engine = new Rete.Engine('node-editor@0.1.0');

      //!REGISTER_COMPONENTS

      editor.on('process nodecreated noderemoved connectioncreated connectionremoved', async () => {
        await engine.abort();
        await engine.process(editor.toJSON());
      });

      editor.view.resize();
      AreaPlugin.zoomAt(editor);
      editor.trigger('process');
    })();
  </script>

</body>

</html>