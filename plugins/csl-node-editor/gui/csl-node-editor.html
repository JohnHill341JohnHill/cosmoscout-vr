<!-- 
SPDX-FileCopyrightText: German Aerospace Center (DLR) <cosmoscout@dlr.de>
SPDX-License-Identifier: MIT
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Node Editor</title>

  <script src="https://cdn.jsdelivr.net/npm/rete@1.5.0-rc1/build/rete.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alight@0.14.1/alight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-vue-render-plugin@0.5.1/build/vue-render-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-connection-plugin@0.9.0/build/connection-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-context-menu-plugin@0.5.2/build/context-menu-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-history-plugin@0.1.0/build/history-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-area-plugin@0.2.1/build/area-plugin.min.js"></script>

  <script type="text/javascript" src="third-party/js/jquery-2.2.3.min.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap-datepicker.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap-select.min.js"></script>

  <script type="text/javascript" src="third-party/js/d3.min.js"></script>
  <script type="text/javascript" src="third-party/js/fuzzyset.js"></script>
  <script type="text/javascript" src="third-party/js/nouislider.min.js"></script>

  <link type="text/css" rel="stylesheet" href="third-party/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="third-party/css/bootstrap-select.min.css" />
  <link type="text/css" rel="stylesheet" href="third-party/css/nouislider.css">

  <link type="text/css" rel="stylesheet" href="css/calendar.css">
  <link type="text/css" rel="stylesheet" href="css/gui.css">
  <link type="text/css" rel="stylesheet" href="css/csl-node-editor.css">
</head>

<body>

  <div id="loading-screen">
    <div class="wrapper">
      <div class="spinner"></div>
      <p>connecting...</p>
    </div>
  </div>

  <div id="rete"></div>

  <script type="text/javascript">
    function toKebabCase(string) {
      return string
        .replace(/([a-z])([A-Z])/g, "$1-$2")
        .replace(/[\s_]+/g, '-')
        .toLowerCase();
    }

    function addSocketStyle(name, color) {
      const css = document.createElement("style");
      css.innerText = `
        .socket.${toKebabCase(name)} {
          background: ${color};
        }
      `;
      document.head.appendChild(css);
    }

    CosmoScout = {
      socketTypes: [],
      connection: null,
      nodeEditor: null,
    };

    CosmoScout.connection = new WebSocket('ws://' + window.location.host + '/socket');
    CosmoScout.connection.addEventListener('error', (error) => {
      alert('Connection to CosmoScout VR was interupted.');
      CosmoScout.connection.close();
    });
    CosmoScout.connection.addEventListener('open', () => {
      document.getElementById("loading-screen").classList.add("hidden");
      console.log("connected!");
    });

    //!SOCKET_SOURCE_CODE

    //!NODE_SOURCE_CODE

    (async () => {
      const container = document.querySelector('#rete');

      const background = document.createElement('div');
      background.classList = 'background';

      CosmoScout.nodeEditor = new Rete.NodeEditor('node-editor@0.1.0', container);
      CosmoScout.nodeEditor.use(ConnectionPlugin.default, { curvature: 0.2 });
      CosmoScout.nodeEditor.use(VueRenderPlugin.default);
      CosmoScout.nodeEditor.use(ContextMenuPlugin.default, {
        delay: 0,
        allocate(component) {
          return component.category ? [component.category] : [];
        },
      });
      CosmoScout.nodeEditor.use(AreaPlugin, { background });
      CosmoScout.nodeEditor.use(HistoryPlugin);

      //!REGISTER_COMPONENTS

      CosmoScout.nodeEditor.on('nodecreated', node => {
        CosmoScout.connection.send(JSON.stringify({
          eventType: "addNode", node: {
            type: node.name,
            id: node.id
          }
        }));
      });

      CosmoScout.nodeEditor.on('noderemoved', node => {
        CosmoScout.connection.send(JSON.stringify({
          eventType: "removeNode", node: {
            id: node.id
          }
        }));
      });

      CosmoScout.nodeEditor.on('connectioncreated', connection => {
        CosmoScout.connection.send(JSON.stringify({
          eventType: "addConnection", connection: {
            fromNode: connection.output.node.id,
            fromSocket: connection.output.key,
            toNode: connection.input.node.id,
            toSocket: connection.input.key
          }
        }));
      });

      CosmoScout.nodeEditor.on('connectionremoved', connection => {
        CosmoScout.connection.send(JSON.stringify({
          eventType: "removeConnection", connection: {
            fromNode: connection.output.node.id,
            fromSocket: connection.output.key,
            toNode: connection.input.node.id,
            toSocket: connection.input.key
          }
        }));
      });

      CosmoScout.nodeEditor.view.resize();
      AreaPlugin.zoomAt(CosmoScout.nodeEditor);
      CosmoScout.nodeEditor.trigger('process');
    })();
  </script>

</body>

</html>