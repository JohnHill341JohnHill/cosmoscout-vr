<!-- 
SPDX-FileCopyrightText: German Aerospace Center (DLR) <cosmoscout@dlr.de>
SPDX-License-Identifier: MIT
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Node Editor</title>

  <script src="https://cdn.jsdelivr.net/npm/rete@1.5.0-rc1/build/rete.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alight@0.14.1/alight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-connection-plugin@0.9.0/build/connection-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-context-menu-plugin@0.5.2/build/context-menu-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-history-plugin@0.1.0/build/history-plugin.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/rete-area-plugin@0.2.1/build/area-plugin.min.js"></script>

  <script type="text/javascript" src="third-party/js/jquery-2.2.3.min.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap-datepicker.js"></script>
  <script type="text/javascript" src="third-party/js/bootstrap-select.min.js"></script>

  <script type="text/javascript" src="third-party/js/d3.min.js"></script>
  <script type="text/javascript" src="third-party/js/fuzzyset.js"></script>
  <script type="text/javascript" src="third-party/js/nouislider.min.js"></script>

  <link type="text/css" rel="stylesheet" href="third-party/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="third-party/css/bootstrap-select.min.css" />
  <link type="text/css" rel="stylesheet" href="third-party/css/nouislider.css">

  <link type="text/css" rel="stylesheet" href="css/calendar.css">
  <link type="text/css" rel="stylesheet" href="css/gui.css">
  <link type="text/css" rel="stylesheet" href="css/csl-node-editor.css">
</head>

<body>

  <div id="rete"></div>

  <div id="loading-screen">
    <div class="wrapper">
      <div class="spinner"></div>
      <h2>connecting...</h2>
    </div>
  </div>

  <div id="connection-failed" class="hidden">
    <div class="wrapper">
      <h2>Failed to connect to CosmoScout VR!</h2>
      <p class="small">Maybe there is already another connection open?</p>
      <button type="button" class="btn btn-lg glass" onclick="location.reload()">Retry</button>
    </div>
  </div>

  <script type="text/javascript">
    function toKebabCase(string) {
      return string
        .replace(/([a-z])([A-Z])/g, "$1-$2")
        .replace(/[\s_]+/g, '-')
        .toLowerCase();
    }

    function addSocketStyle(name, color) {
      const css = document.createElement("style");
      css.innerText = `
        .socket.${toKebabCase(name)} {
          background: ${color};
        }
      `;
      document.head.appendChild(css);
    }

    CosmoScout = {
      socketTypes: [],
      connection: null,
      nodeEditor: null,
      sendMessagetoCPP: (message, toNode) => {
        CosmoScout.connection.send(JSON.stringify({
          type: "nodeMessage", data: { message: message, toNode: toNode }
        }));
      }
    };

    CosmoScout.connection = new WebSocket('ws://' + window.location.host + '/socket');

    CosmoScout.connection.onerror = error => {
      document.getElementById("loading-screen").classList.add("hidden");
      document.getElementById("connection-failed").classList.remove("hidden");
    };

    CosmoScout.connection.onopen = () => {
      CosmoScout.connection.onclose = () => {
        alert('Connection to CosmoScout VR was interupted.');
      };
    };

    CosmoScout.connection.onmessage = e => {
      let event = JSON.parse(e.data);

      if (event.type === "nodeMessage") {
        let node = CosmoScout.nodeEditor.nodes.find(node => node.id === event.data.toNode);

        if (node.onMessageFromCPP) {
          node.onMessageFromCPP(event.data.message);
        }

      } else if (event.type === "loadGraph") {
        CosmoScout.nodeEditor.fromJSON({ id: "node-editor@0.1.0", nodes: event.data.nodes }).then(() => {

          for (const [id, node] of Object.entries(event.data.nodes)) {
            if (node.collapsed) {
              document.querySelector("#node-" + id).classList.add("collapsed");
            }
          }

          AreaPlugin.zoomAt(CosmoScout.nodeEditor);
          CosmoScout.nodeEditor.nodes.forEach(node => CosmoScout.nodeEditor.view.updateConnections({ node: node }));

          document.getElementById("loading-screen").classList.add("hidden");
          CosmoScout.connection.send(JSON.stringify({
            type: "graphLoaded", data: {}
          }));
        });
      }
    };

    //!SOCKET_SOURCE_CODE

    //!NODE_SOURCE_CODE

    (async () => {
      const container = document.querySelector('#rete');

      const background = document.createElement('div');
      background.classList = 'background';

      CosmoScout.nodeEditor = new Rete.NodeEditor('node-editor@0.1.0', container);
      CosmoScout.nodeEditor.use(ConnectionPlugin.default);
      CosmoScout.nodeEditor.use(ContextMenuPlugin.default, {
        delay: 0,
        allocate(component) {
          return component.category ? [component.category] : [];
        },
      });
      CosmoScout.nodeEditor.use(AreaPlugin, { background });
      CosmoScout.nodeEditor.use(HistoryPlugin);

      //!REGISTER_COMPONENTS

      CosmoScout.nodeEditor.on('nodecreated', node => {
        if (CosmoScout.nodeEditor.silent) {
          return;
        }

        CosmoScout.connection.send(JSON.stringify({
          type: "addNode", data: {
            type: node.name,
            id: node.id,
            position: node.position
          }
        }));
      });

      CosmoScout.nodeEditor.on('noderemoved', node => {
        CosmoScout.connection.send(JSON.stringify({
          type: "removeNode", data: {
            id: node.id
          }
        }));
      });

      CosmoScout.nodeEditor.on('nodetranslated', ({ node, prev }) => {
        CosmoScout.connection.send(JSON.stringify({
          type: "translateNode", data: {
            id: node.id,
            position: node.position
          }
        }));
      });

      CosmoScout.nodeEditor.on('connectioncreated', connection => {
        if (CosmoScout.nodeEditor.silent) {
          return;
        }

        CosmoScout.connection.send(JSON.stringify({
          type: "addConnection", data: {
            fromNode: connection.output.node.id,
            fromSocket: connection.output.key,
            toNode: connection.input.node.id,
            toSocket: connection.input.key
          }
        }));
      });

      CosmoScout.nodeEditor.on('connectionremoved', connection => {
        CosmoScout.connection.send(JSON.stringify({
          type: "removeConnection", data: {
            fromNode: connection.output.node.id,
            fromSocket: connection.output.key,
            toNode: connection.input.node.id,
            toSocket: connection.input.key
          }
        }));
      });

      CosmoScout.nodeEditor.on('connectioncreate', ({ input, output }) => {
        return input.node.id != output.node.id;
      });

      CosmoScout.nodeEditor.on('rendernode', ({ el, node, component, bindSocket, bindControl }) => {

        el.id = "node-" + node.id;
        el.className = "node";

        const title = document.createElement('div');
        title.className = "title";
        title.innerHTML = `<span>${node.name}</span><i class='material-icons caret-icon'>keyboard_arrow_left</i>`;
        el.appendChild(title);

        el.addEventListener('dblclick', event => {
          event.stopPropagation();
        });

        title.addEventListener("pointerdown", () => {
          el._wasDragged = false;
        });
        title.addEventListener("pointermove", () => {
          el._wasDragged = true;
        });

        title.addEventListener("click", () => {
          if (el._wasDragged) {
            return;
          }

          el.classList.toggle("collapsed");

          CosmoScout.connection.send(JSON.stringify({
            type: "collapseNode", data: {
              id: node.id,
              collapsed: el.classList.contains("collapsed")
            }
          }));

          CosmoScout.nodeEditor.view.updateConnections({ node: node });
        });

        const inputs = document.createElement('div');
        inputs.className = "inputs";
        el.appendChild(inputs);

        node.inputs.forEach(i => {
          const input = document.createElement('div');
          input.className = "input";

          const title = document.createElement('span');
          title.className = "input-title";
          title.textContent = i.name;

          const socket = document.createElement('span');
          socket.className = `socket ${toKebabCase(i.socket.name)}`;

          inputs.appendChild(input);
          input.appendChild(socket);
          input.appendChild(title);

          bindSocket(socket, "input", i);
        });

        const controls = document.createElement('div');
        controls.className = "controls";
        el.appendChild(controls);

        node.controls.forEach(c => {
          const control = document.createElement('div');
          control.className = "control";
          control.innerHTML = c.template;

          controls.appendChild(control);

          bindControl(control, c);
        });

        const outputs = document.createElement('div');
        outputs.className = "outputs";
        el.appendChild(outputs);

        node.outputs.forEach(o => {
          const output = document.createElement('div');
          output.className = "output";

          const title = document.createElement('span');
          title.className = "output-title";
          title.textContent = o.name;

          const socket = document.createElement('span');
          socket.className = `socket ${toKebabCase(o.socket.name)}`;

          outputs.appendChild(output);
          output.appendChild(title);
          output.appendChild(socket);

          bindSocket(socket, "output", o);
        });

        if (node.onInit) {
          node.onInit(el);
        }
      });

      CosmoScout.nodeEditor.view.resize();
      AreaPlugin.zoomAt(CosmoScout.nodeEditor);
    })();
  </script>

</body>

</html>